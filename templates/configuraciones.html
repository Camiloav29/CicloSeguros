<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Configuraciones - {{ config.get('nombre_empresa') }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='configuraciones_panel.css') }}">
</head>
<body>
    <div class="config-wrapper">
        <!-- Sidebar -->
        <aside class="config-sidebar">
            <div class="sidebar-header">
                <h2>Configuración</h2>
                <p>{{ config.get('nombre_empresa') }}</p>
            </div>
            <ul class="sidebar-nav">
                <li>
                    <a href="{{ url_for('index') }}">
                        <i class="fas fa-arrow-left"></i> Volver al Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link active" data-target="general">
                        <i class="fas fa-info-circle"></i> Información General
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="logo">
                        <i class="fas fa-image"></i> Apariencia y Marca
                    </a>
                </li>
                <li>
                    <div class="accordion-header">
                        <span><i class="fas fa-list"></i> Listas de Datos</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <input type="text" id="list-search" placeholder="Buscar lista..." style="width: 85%; margin: 0.5rem 1.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        {% for list_name, items in config.get('listas', {}).items() %}
                            <a href="#" class="nav-link" data-target="lista-{{ list_name }}">{{ config.get('display_name_map', {}).get(list_name, list_name.replace('_', ' ')|capitalize) }}</a>
                        {% endfor %}
                    </div>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="config-main" id="config-content-area">
            <!-- El contenido se cargará aquí dinámicamente -->
            <div class="content-card">
                <h2>Bienvenido al Panel de Configuraciones</h2>
                <p>Seleccione una opción del menú de la izquierda para comenzar a editar.</p>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.querySelector('.config-sidebar');
        const contentArea = document.getElementById('config-content-area');
        const navLinks = document.querySelectorAll('.nav-link');
        const accordionHeader = document.querySelector('.accordion-header');
        const accordionContent = document.querySelector('.accordion-content');
        const listSearch = document.getElementById('list-search');

        // Function to load content dynamically
        function loadContent(target) {
            let url;
            if (target.startsWith('lista-')) {
                const listName = target.replace('lista-', '');
                url = `/configuraciones/listas/${listName}`;
            } else {
                url = `/configuraciones/partials/${target}`;
            }

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    contentArea.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    contentArea.innerHTML = '<div class="content-card"><h2>Error</h2><p>No se pudo cargar el contenido. Por favor, intente de nuevo.</p></div>';
                });
        }

        // Handle sidebar navigation clicks
        sidebar.addEventListener('click', function(e) {
            const link = e.target.closest('.nav-link');
            if (link) {
                e.preventDefault();

                // Update active class
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                const target = link.dataset.target;
                loadContent(target);
            }
        });

        // Accordion functionality
        accordionHeader.addEventListener('click', function() {
            this.classList.toggle('open');
            const icon = this.querySelector('.fa-chevron-down');
            icon.style.transform = this.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';

            if (accordionContent.style.maxHeight) {
                accordionContent.style.maxHeight = null;
            } else {
                accordionContent.style.maxHeight = accordionContent.scrollHeight + "px";
            }
        });

        // Search functionality for lists
        listSearch.addEventListener('keyup', function() {
            const filter = listSearch.value.toLowerCase();
            const links = accordionContent.querySelectorAll('a');
            links.forEach(link => {
                const text = link.textContent.toLowerCase();
                if (text.includes(filter)) {
                    link.style.display = '';
                } else {
                    link.style.display = 'none';
                }
            });
        });

        // Load initial content (General tab)
        loadContent('general');

        // --- Toast Notification Logic ---
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => { toast.classList.add('show'); }, 100); // Fade in

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300); // Remove from DOM after fade out
            }, 4000);
        }

        // --- Asynchronous Form Submission ---
        contentArea.addEventListener('submit', function(e) {
            const form = e.target.closest('form');
            if (form) {
                e.preventDefault();

                const formData = new FormData(form);
                const url = form.action;

                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        // If the form was for a list, reload the list content to show the change
                        const listName = new URL(url).pathname.split('/').pop();
                        const activeLink = document.querySelector('.nav-link.active');
                        if (activeLink && activeLink.dataset.target.startsWith('lista-')) {
                            loadContent(activeLink.dataset.target);
                        }
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Form submission error:', error);
                    showToast('Error de conexión al guardar.', 'error');
                });
            }
        });
    });
    </script>
</body>
</html>
