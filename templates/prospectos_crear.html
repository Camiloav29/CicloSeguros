<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Nuevo Prospecto - UIB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/prospectos_styles.css">
</head>
<body>
    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <a href="{{ url_for('prospectos_vista') }}" class="back-to-link"><i class="fas fa-arrow-left"></i> Volver a Prospectos</a>
                <h1><i class="fas fa-user-plus"></i> Registrar Nuevo Prospecto</h1>
                <p>Ingrese los detalles del nuevo prospecto.</p>
            </div>

            <div id="notification-container" class="notification-placeholder" style="display: none;"></div>

            <form id="prospecto-form">
                <fieldset>
                    <legend><i class="fas fa-user-tie"></i> Información del Prospecto</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre_cliente">Nombre Cliente</label>
                            <input type="text" id="nombre_cliente" name="Nombre Cliente" required>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="responsable_tecnico">Responsable Técnico</label>
                            <select id="responsable_tecnico" name="Responsable Tecnico" required>
                                <option value="">Seleccione...</option>
                                {% for opt in opciones_responsable_tecnico %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="responsable_comercial">Responsable Comercial</label>
                            <select id="responsable_comercial" name="Responsable Comercial" required>
                                <option value="">Seleccione...</option>
                                {% for opt in opciones_responsable_comercial %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend><i class="fas fa-file-contract"></i> Detalles de la Cotización</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha_cotizacion">Fecha de Cotización</label>
                            <input type="date" id="fecha_cotizacion" name="Fecha de Cotizacion" required>
                        </div>
                        <div class="form-group">
                            <label for="fecha_inicio_poliza">Fecha Emisión</label>
                            <input type="date" id="fecha_inicio_poliza" name="Fecha inicio poliza">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ramo">Ramo</label>
                            <select id="ramo" name="Ramo">
                                <option value="">Seleccione...</option>
                                {% for opt in opciones_ramo %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aseguradora">Aseguradora</label>
                            <select id="aseguradora" name="Aseguradora">
                                <option value="">Seleccione...</option>
                                {% for opt in opciones_aseguradora %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="prima">Prima</label>
                            <input type="text" id="prima" name="Prima" class="currency" placeholder="$0" required>
                        </div>
                        <div class="form-group">
                            <label for="comision_porcentaje">Comisión %</label>
                            <input type="number" id="comision_porcentaje" name="Comision %" step="0.01" placeholder="0.0" required>
                        </div>
                        <div class="form-group">
                            <label for="comision_valor">Comisión $ (Calculado)</label>
                            <input type="text" id="comision_valor" name="Comision $" readonly>
                        </div>
                    </div>
                </fieldset>
                
                <fieldset>
                    <legend><i class="fas fa-handshake"></i> TPP</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="es_tpp">¿Es TPP?</label>
                            <select id="es_tpp" name="es_TPP">
                                <option value="no" selected>No</option>
                                <option value="si">Sí</option>
                            </select>
                        </div>
                    </div>
                    <div id="tpp-details" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombre_tpp">Nombre TPP</label>
                                <select id="nombre_tpp" name="Nombre_TPP">
                                    <option value="">Seleccione Vendedor...</option>
                                    {% for opt in opciones_vendedor %}
                                    <option value="{{ opt }}">{{ opt }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="porcentaje_comision_tpp">Porcentaje Comisión TPP</label>
                                <input type="number" id="porcentaje_comision_tpp" name="Porcentaje_comision_TPP" step="0.01" placeholder="0.0">
                            </div>
                            <div class="form-group">
                                <label for="valor_comision_tpp">Valor Comisión TPP (Calculado)</label>
                                <input type="text" id="valor_comision_tpp" name="Valor_Comision_TPP" readonly>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend><i class="fas fa-cogs"></i> Estado y Seguimiento</legend>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="estado">Estado</label>
                            <select id="estado" name="Estado" required>
                                {% for opt in opciones_estado %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" name="Observaciones" rows="3"></textarea>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn btn-submit"><i class="fas fa-save"></i> Guardar Prospecto</button>
                </div>
            </form>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const primaInput = document.getElementById('prima');
        const comisionPorcentajeInput = document.getElementById('comision_porcentaje');
        const comisionValorInput = document.getElementById('comision_valor');
        const esTppSelect = document.getElementById('es_tpp');
        const tppDetails = document.getElementById('tpp-details');
        const porcentajeTppInput = document.getElementById('porcentaje_comision_tpp');
        const valorTppInput = document.getElementById('valor_comision_tpp');

        function formatIntegerCurrency(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = '$' + parseInt(value, 10).toLocaleString('es-CO');
            } else {
                input.value = '';
            }
        }

        function calcularComision() {
            const prima = parseFloat(primaInput.value.replace(/\$|\./g, '')) || 0;
            const porcentaje = parseFloat(comisionPorcentajeInput.value) || 0;
            let comisionCalculadaBruta = prima * (porcentaje / 100);
            let comisionFinal = comisionCalculadaBruta;

            if (esTppSelect.value === 'si') {
                const porcentajeTpp = parseFloat(porcentajeTppInput.value) || 0;
                const valorTpp = comisionCalculadaBruta * (porcentajeTpp / 100);
                valorTppInput.value = valorTpp.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                comisionFinal -= valorTpp;
            } else {
                valorTppInput.value = ''; // Limpiar si no es TPP
            }
            
            comisionValorInput.value = comisionFinal.toLocaleString('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        primaInput.addEventListener('input', () => {
            formatIntegerCurrency(primaInput);
            calcularComision();
        });
        comisionPorcentajeInput.addEventListener('input', calcularComision);
        esTppSelect.addEventListener('change', function() {
            tppDetails.style.display = this.value === 'si' ? 'block' : 'none';
            calcularComision();
        });
        porcentajeTppInput.addEventListener('input', calcularComision);
        
        const form = document.getElementById('prospecto-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const submitBtn = form.querySelector('.btn-submit');
            const originalBtnText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            fetch("{{ url_for('crear_prospecto') }}", {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification-container');
                notification.textContent = data.message;
                if (data.status === 'success') {
                    notification.className = 'flash-message flash-success';
                    form.reset();
                    comisionValorInput.value = ''; // Clear calculated field
                    tppDetails.style.display = 'none'; // Hide TPP section on reset
                    valorTppInput.value = ''; // Clear TPP value
                } else {
                    notification.className = 'flash-message flash-danger';
                }
                notification.style.display = 'block';
                 setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error:', error);
                const notification = document.getElementById('notification-container');
                notification.textContent = 'Error de conexión. Intente de nuevo.';
                notification.className = 'flash-message flash-danger';
                notification.style.display = 'block';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        });
    });
    </script>
</body>
</html>
