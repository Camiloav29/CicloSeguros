<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista de Prospectos - {{ nombre_empresa }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/prospectos_styles.css">
</head>
<body>
    <div class="container-fluid">
        <header class="page-header">
            <h1><i class="fas fa-users"></i> Módulo de Prospectos</h1>
            <div class="header-actions">
                <a href="{{ url_for('crear_prospecto') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Registrar Prospecto</a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
            </div>
        </header>

        <div id="notification-container-vista" class="notification-placeholder" style="display: none;"></div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="kpi-info">
                    <div class="kpi-value">{{ "${:,.0f}".format(kpi_recaudo_mes) }}</div>
                    <div class="kpi-label">Recaudo Acumulado del Mes</div>
                </div>
            </div>
            {% for ramo in kpi_top_ramos %}
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-medal"></i></div>
                <div class="kpi-info">
                    <div class="kpi-value">{{ "${:,.0f}".format(ramo['Comision $']) }}</div>
                    <div class="kpi-label">{{ ramo.Ramo }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="filter-bar card">
            <form id="filter-form" class="form-inline">
                <div class="form-group">
                    <label for="filtro_responsable_tecnico">Responsable Técnico:</label>
                    <select name="filtro_responsable_tecnico" id="filtro_responsable_tecnico" class="form-control">
                        <option value="">Todos</option>
                        {% for opt in opciones_responsable_tecnico %}
                        <option value="{{ opt }}">{{ opt }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtro_estado">Estado:</label>
                    <select name="filtro_estado" id="filtro_estado" class="form-control">
                        <option value="">Todos</option>
                        {% for opt in opciones_estado %}
                        <option value="{{ opt }}">{{ opt }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="form-group">
                    <label for="search_query">Buscar:</label>
                    <input type="text" id="search_query" name="search_query" class="form-control" placeholder="Nombre, ramo, aseguradora...">
                </div>
            </form>
        </div>

        <div class="table-responsive card">
            <table id="prospectos-table" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nombre Cliente</th>
                        <th>Resp. Técnico</th>
                        <th>Resp. Comercial</th>
                        <th>Fecha Cotización</th>
                        <th>Fecha Emisión</th>
                        <th>Ramo</th>
                        <th>Aseguradora</th>
                        <th>¿Es TPP?</th>
                        <th>Nombre TPP</th>
                        <th>% Comisión TPP</th>
                        <th>Valor Comisión TPP</th>
                        <th>Prima</th>
                        <th>Comisión %</th>
                        <th>Comisión $</th>
                        <th>Estado</th>
                        <th>Observaciones</th>
                        <th class="actions-column">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% if prospectos %}
                        {% for prospecto in prospectos %}
                            <tr data-id="{{ prospecto.ID_PROSPECTO }}">
                                <td data-label="Nombre Cliente">{{ prospecto['Nombre Cliente'] }}</td>
                                <td data-label="Resp. Técnico">{{ prospecto['Responsable Tecnico'] }}</td>
                                <td data-label="Resp. Comercial">{{ prospecto['Responsable Comercial'] }}</td>
                                <td data-label="Fecha Cotización">{{ prospecto['Fecha de Cotizacion'] }}</td>
                                <td data-label="Fecha Emisión">{{ prospecto['Fecha inicio poliza'] }}</td>
                                <td data-label="Ramo">{{ prospecto.Ramo }}</td>
                                <td data-label="Aseguradora">{{ prospecto.Aseguradora }}</td>
                                <td data-label="¿Es TPP?">{{ prospecto.es_TPP }}</td>
                                <td data-label="Nombre TPP">{{ prospecto.Nombre_TPP }}</td>
                                <td data-label="% Comisión TPP" class="percentage">{{ prospecto.Porcentaje_comision_TPP }}</td>
                                <td data-label="Valor Comisión TPP" class="valor-comision-tpp currency"></td>
                                <td data-label="Prima" class="prima-valor currency">{{ prospecto.Prima }}</td>
                                <td data-label="Comisión %" class="comision-porc-valor percentage">{{ prospecto['Comision %'] }}</td>
                                <td data-label="Comisión $" class="comision-valor currency">{{ prospecto['Comision $'] }}</td>
                                <td data-label="Estado" class="estado-cell">
                                    <span class="status-badge status-{{ prospecto.Estado | lower | replace(' ', '-') }}">{{ prospecto.Estado }}</span>
                                </td>
                                <td data-label="Observaciones">{{ prospecto.Observaciones }}</td>
                                <td data-label="Acciones" class="actions-cell">
                                    <a href="{{ url_for('prospecto_editar', prospecto_id=prospecto.ID_PROSPECTO) }}" class="btn btn-sm btn-secondary" title="Editar Prospecto">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    {% if prospecto.Estado not in ['Ganado', 'Perdido'] %}
                                    <button class="btn btn-sm btn-success btn-ganado" title="Marcar como Ganado"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-sm btn-danger btn-perdido" title="Marcar como Perdido"><i class="fas fa-times"></i></button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="17">No hay prospectos para mostrar.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1001;"></canvas>

    <!-- Overlay y Modal de Notificación de Estado -->
    <div id="status-overlay" class="status-overlay"></div>
    <div id="status-notification-box" class="status-notification-box">
        <div id="status-icon"></div>
        <h2 id="status-message"></h2>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace(/\$|\./g, '').replace(',', '.')) || 0;
        }

        function formatCurrency(value) {
            const number = parseCurrency(value);
            if (isNaN(number)) return '';
            return number.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatPercentage(value) {
            const number = parseFloat(value);
            if (isNaN(number) || value === null || value === '') return '';
            return `${number.toFixed(1)}%`;
        }

        function setupRow(row) {
            // Formatear celdas de moneda y porcentaje al cargar
            row.querySelectorAll('.currency').forEach(cell => {
                if (cell.textContent.trim() !== '') {
                    cell.textContent = formatCurrency(cell.textContent);
                }
            });
            row.querySelectorAll('.percentage').forEach(cell => {
                if (cell.textContent.trim() !== '') {
                    cell.textContent = formatPercentage(cell.textContent);
                }
            });

            // --- Calcular y mostrar Valor Comisión TPP ---
            const esTpp = row.cells[7].textContent.trim().toLowerCase() === 'si';
            const valorTppCell = row.querySelector('.valor-comision-tpp');
            
            if (esTpp && valorTppCell) {
                const primaText = row.querySelector('.prima-valor').textContent;
                const comisionPorcText = row.querySelector('.comision-porc-valor').textContent;
                const porcTppText = row.cells[9].textContent;

                const prima = parseCurrency(primaText);
                const comisionPorc = parseFloat(comisionPorcText) / 100 || 0;
                const porcTpp = parseFloat(porcTppText) / 100 || 0;
                
                const comisionBruta = prima * comisionPorc;
                const valorTpp = comisionBruta * porcTpp;
                
                valorTppCell.textContent = formatCurrency(valorTpp);
            } else if (valorTppCell) {
                valorTppCell.textContent = formatCurrency(0);
            }

            // --- Lógica para mostrar/ocultar botones de acción ---
            const actionsCell = row.querySelector('.actions-cell');
            const estadoBadge = row.querySelector('.status-badge');
            if (!actionsCell || !estadoBadge) return;
            
            const estado = estadoBadge.textContent.trim();
            const prospectoId = row.dataset.id;

            // Si el estado es Ganado o Perdido, quitar los botones de acción de estado
            if (estado === 'Ganado' || estado === 'Perdido') {
                const ganadoBtn = actionsCell.querySelector('.btn-ganado');
                const perdidoBtn = actionsCell.querySelector('.btn-perdido');
                if (ganadoBtn) ganadoBtn.remove();
                if (perdidoBtn) perdidoBtn.remove();
            }

            // Si el estado es Ganado, añadir el botón de Radicar si no existe ya
            if (estado === 'Ganado' && !actionsCell.querySelector('.btn-radicar')) {
                const radicarBtn = document.createElement('a');
                const tomador = row.cells[0].textContent;
                const ramo = row.cells[5].textContent;
                const aseguradora = row.cells[6].textContent;
                const prima_text = row.querySelector('.prima-valor').textContent;
                const prima_neta = parseCurrency(prima_text);

                const params = new URLSearchParams({
                    tomador: tomador,
                    ramo: ramo,
                    aseguradora: aseguradora,
                    prima_neta: prima_neta,
                    poliza: `PROS-${prospectoId}`
                });
                
                radicarBtn.href = `{{ url_for('formulario_remision') }}?${params.toString()}`;
                radicarBtn.className = 'btn btn-sm btn-primary btn-radicar';
                radicarBtn.innerHTML = '<i class="fas fa-file-alt"></i> Radicar';
                radicarBtn.title = 'Radicar Remisión';
                
                actionsCell.appendChild(radicarBtn);
            }
        }

        // Procesar todas las filas al cargar la página
        const tableRows = document.querySelectorAll('#prospectos-table tbody tr');
        tableRows.forEach(setupRow);

        // Lógica de filtrado
        const filtroResponsable = document.getElementById('filtro_responsable_tecnico');
        const filtroEstado = document.getElementById('filtro_estado');
        const searchQuery = document.getElementById('search_query');

        function filterTable() {
            const respFiltro = filtroResponsable.value.toLowerCase();
            const estadoFiltro = filtroEstado.value.toLowerCase();
            const searchFiltro = searchQuery.value.toLowerCase();

            tableRows.forEach(row => {
                if(row.cells.length < 2) return; // Skip empty rows
                const respTecnico = row.cells[1].textContent.toLowerCase();
                const estado = row.querySelector('.status-badge') ? row.querySelector('.status-badge').textContent.toLowerCase().trim() : '';
                const rowText = row.textContent.toLowerCase();

                const respMatch = !respFiltro || respTecnico.includes(respFiltro);
                const estadoMatch = !estadoFiltro || estado.includes(estadoFiltro);
                const searchMatch = !searchFiltro || rowText.includes(searchFiltro);

                row.style.display = (respMatch && estadoMatch && searchMatch) ? '' : 'none';
            });
        }
        
        filtroResponsable.addEventListener('change', filterTable);
        filtroEstado.addEventListener('change', filterTable);
        searchQuery.addEventListener('input', filterTable);

        // Lógica para botones de Ganado/Perdido
        document.getElementById('prospectos-table').addEventListener('click', function(event) {
            const target = event.target.closest('.btn-ganado, .btn-perdido');
            if (!target) return;

            const row = target.closest('tr');
            const prospectoId = row.dataset.id;
            const nuevoEstado = target.classList.contains('btn-ganado') ? 'Ganado' : 'Perdido';
            
            target.disabled = true;
            target.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch("{{ url_for('actualizar_estado_prospecto') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prospecto_id: prospectoId, estado: nuevoEstado })
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification-container-vista');
                notification.textContent = data.message;
                if (data.status === 'success') {
                    notification.className = 'flash-message flash-success';
                    
                    const estadoCell = row.querySelector('.estado-cell');
                    estadoCell.innerHTML = `<span class="status-badge status-${nuevoEstado.toLowerCase().replace(' ', '-')}">${nuevoEstado}</span>`;
                    
                    if (data.fecha_emision) {
                        row.cells[4].textContent = data.fecha_emision;
                    }
                    
                    // Re-procesar la fila para actualizar todo (botones, etc.)
                    setupRow(row); 
                    
                    if (nuevoEstado === 'Ganado') {
                        showStatusNotification('won');
                    } else {
                        showStatusNotification('lost');
                    }

                } else {
                    notification.className = 'flash-message flash-danger';
                    target.disabled = false;
                    target.innerHTML = nuevoEstado === 'Ganado' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
                }
                 notification.style.display = 'block';
                 setTimeout(() => { notification.style.display = 'none'; }, 3000);
            })
            .catch(error => {
                 console.error('Error:', error);
                 const notification = document.getElementById('notification-container-vista');
                 notification.textContent = 'Error de conexión. Intente de nuevo.';
                 notification.className = 'flash-message flash-danger';
                 notification.style.display = 'block';
                 target.disabled = false;
                 target.innerHTML = nuevoEstado === 'Ganado' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
            });
        });

        function showStatusNotification(type) {
            const overlay = document.getElementById('status-overlay');
            const box = document.getElementById('status-notification-box');
            const icon = document.getElementById('status-icon');
            const message = document.getElementById('status-message');

            if (type === 'won') {
                icon.innerHTML = '🏆';
                message.textContent = '¡Felicitaciones!';
                triggerConfettiRain();
            } else {
                icon.innerHTML = '🙁';
                message.textContent = 'Una lástima...';
            }

            overlay.style.display = 'block';
            box.style.display = 'block';

            setTimeout(() => {
                overlay.style.display = 'none';
                box.style.display = 'none';
            }, 3000);
        }

        function triggerConfettiRain() {
            const myCanvas = document.getElementById('confetti-canvas');
            const myConfetti = confetti.create(myCanvas, { resize: true });
            const duration = 2 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1001 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }
                const particleCount = 50 * (timeLeft / duration);
                myConfetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                myConfetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
    });
    </script>
</body>
</html>
    